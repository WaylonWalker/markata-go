# Caddyfile for markata-go production deployment
# Automatic HTTPS with Let's Encrypt

{$SITE_DOMAIN:example.com} {
    root * /srv
    file_server

    # Enable compression
    encode gzip zstd

    # Security headers
    header {
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        X-XSS-Protection "1; mode=block"
        # Remove server header
        -Server
    }

    # Cache static assets aggressively
    @static {
        path /static/*
        path *.css
        path *.js
        path *.woff2
        path *.woff
        path *.ttf
        path *.ico
        path *.png
        path *.jpg
        path *.jpeg
        path *.gif
        path *.svg
        path *.webp
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # Don't cache HTML files
    @html path *.html
    header @html Cache-Control "no-cache, no-store, must-revalidate"

    # Cache XML feeds for 1 hour
    @feeds {
        path *.xml
        path *.rss
        path *.atom
    }
    header @feeds Cache-Control "public, max-age=3600"

    # Handle clean URLs
    try_files {path} {path}/ {path}/index.html

    # Custom 404 page
    handle_errors {
        @404 expression {http.error.status_code} == 404
        rewrite @404 /404.html
        file_server
    }

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}

# Redirect www to non-www
www.{$SITE_DOMAIN:example.com} {
    redir https://{$SITE_DOMAIN:example.com}{uri} permanent
}
