{% extends "base.html" %}

{% block title %}{{ post.title }} | {{ config.title | default:'My Site' }}{% endblock %}
{% block description %}{{ post.description | default:'' }}{% endblock %}

{% block meta %}
{{ block.Super() }}
{# Canonical URL for SEO #}
<link rel="canonical" href="{{ config.url }}{{ post.href }}">

{# Alternate format links #}
{% if config.post_formats.markdown %}
<link rel="alternate" type="text/markdown" title="Markdown Source" href="/{{ post.slug }}.md">
{% endif %}
{% if config.post_formats.text %}
<link rel="alternate" type="text/plain" title="Plain Text" href="/{{ post.slug }}.txt">
{% endif %}
{% if config.post_formats.og %}
<link rel="alternate" type="text/html" title="Social Card" href="{{ post.href }}og/">
{% endif %}

{# Structured Data: JSON-LD #}
{% if post.structured_data.jsonld %}
<script type="application/ld+json">
{{ post.structured_data.jsonld | safe }}
</script>
{% endif %}

{# Structured Data: OpenGraph meta tags #}
{% if post.structured_data.opengraph %}
{% for meta in post.structured_data.opengraph %}
<meta property="{{ meta.property }}" content="{{ meta.content }}">
{% endfor %}
{% else %}
{# Fallback to basic OG tags if no structured data #}
<meta property="og:title" content="{{ post.title }}">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ config.url }}{{ post.href }}">
{% if post.description %}
<meta property="og:description" content="{{ post.description }}">
{% endif %}
{% if post.date %}
<meta property="article:published_time" content="{{ post.date | atom_date }}">
{% endif %}
{% if config.post_formats.og %}
<meta property="og:image" content="{{ config.url }}{{ post.href }}og/">
{% endif %}
{% endif %}

{# Structured Data: Twitter Card meta tags #}
{% if post.structured_data.twitter %}
{% for meta in post.structured_data.twitter %}
<meta name="{{ meta.name }}" content="{{ meta.content }}">
{% endfor %}
{% endif %}
{% endblock %}

{% block content %}
<article class="post" data-pagefind-body>
  <header class="post-header">
    <h1 data-pagefind-meta="title">{{ post.title }}</h1>
    {% if post.description %}
    <p class="post-description visually-hidden" data-pagefind-meta="excerpt">{{ post.description }}</p>
    {% endif %}
    {% if post.date or post.reading_time %}
    <div class="post-meta">
      {% if post.date %}<time datetime="{{ post.date | atom_date }}">{{ post.date | date:"January 2, 2006" }}</time>{% endif %}
      {% if post.reading_time %}<span>{{ post.reading_time }} min read</span>{% endif %}
    </div>
    {% endif %}
  </header>

  <div class="post-content{% if post.css_class %} {{ post.css_class }}{% endif %}">
    {{ body | safe }}
  </div>

  {% if post.tags %}
  <footer class="post-footer">
    <div class="tags">
      {% for tag in post.tags %}
      <a href="/tags/{{ tag | slugify }}/" class="tag" data-pagefind-filter="tag">{{ tag }}</a>
      {% endfor %}
    </div>
  </footer>
  {% endif %}

  {# Hidden filters for Pagefind #}
  {% if post.feeds %}
  <div class="pagefind-filters" style="display:none" data-pagefind-ignore>
    {% for feed in post.feeds %}
    <span data-pagefind-filter="feed">{{ feed }}</span>
    {% endfor %}
  </div>
  {% endif %}

  {# Webmentions #}
  {% include "partials/webmentions.html" %}
</article>

{# Use sidebar prev/next if available (for feed-based navigation), otherwise fall back to post.prev/post.next #}
{% if sidebar_prev or sidebar_next %}
<nav class="post-nav">
  {% if sidebar_prev %}<a href="{{ sidebar_prev.href }}" class="prev">{{ sidebar_prev.title }}</a>{% endif %}
  {% if sidebar_next %}<a href="{{ sidebar_next.href }}" class="next">{{ sidebar_next.title }}</a>{% endif %}
</nav>
{% elif post.prev or post.next %}
<nav class="post-nav">
  {% if post.prev %}<a href="{{ post.prev.href }}" class="prev">{{ post.prev.title }}</a>{% endif %}
  {% if post.next %}<a href="{{ post.next.href }}" class="next">{{ post.next.title }}</a>{% endif %}
</nav>
{% endif %}
{% endblock %}
