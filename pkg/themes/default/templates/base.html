<!DOCTYPE html>
<html lang="{{ config.lang | default:'en' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="view-transition" content="same-origin">

  {% block meta %}
  <title>{% block title %}{{ config.title | default:'My Site' }}{% endblock %}</title>
  <meta name="description" content="{% block description %}{{ config.description | default:'' }}{% endblock %}">
  {% endblock %}

  {% block head %}
  <!-- Theme CSS -->
  <link rel="stylesheet" href="{{ 'css/variables.css' | theme_asset_hashed }}">
  <link rel="stylesheet" href="{{ 'css/main.css' | theme_asset_hashed }}">
  <link rel="stylesheet" href="{{ 'css/components.css' | theme_asset_hashed }}">
  <link rel="stylesheet" href="{{ 'css/admonitions.css' | theme_asset_hashed }}">
  <link rel="stylesheet" href="{{ 'css/code.css' | theme_asset_hashed }}">
  <link rel="stylesheet" href="{{ 'css/cards.css' | theme_asset_hashed }}">
  <link rel="stylesheet" href="{{ 'css/webmentions.css' | theme_asset_hashed }}">
  <link rel="stylesheet" href="{{ 'css/chroma.css' | theme_asset_hashed }}">

  <!-- Encryption CSS (always loaded for encrypted posts) -->
  <link rel="stylesheet" href="{{ 'css/encryption.css' | theme_asset_hashed }}">

  <!-- Palette Switcher CSS (when enabled) -->
  {% if config.theme.switcher.enabled %}
  <link rel="stylesheet" href="{{ 'css/palette-switcher.css' | theme_asset_hashed }}">
  {% endif %}

  <!-- Pagefind Search CSS (when enabled) -->
  {% if config.search.enabled %}
  <link rel="stylesheet" href="/{{ config.search.pagefind.bundle_dir | default:'_pagefind' }}/pagefind-ui.css">
  <link rel="stylesheet" href="{{ 'css/search.css' | theme_asset_hashed }}">
  {% endif %}

  <!-- Conditional CSS Loading -->
  <script>
    // GLightbox CSS - only load if glightbox elements will exist
    {% if config.Extra.glightbox_enabled %}
    // Check synchronously during page load
    if (document.documentElement.innerHTML.includes('glightbox')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '{% if config.Extra.asset_urls.glightbox-css %}{{ config.Extra.asset_urls.glightbox-css }}{% elif config.Extra.glightbox_cdn %}https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css{% else %}/css/glightbox.min.css{% endif %}';
      document.head.appendChild(link);
    }
    {% endif %}
  </script>

  <!-- CSS variable overrides from theme config -->
  {% if config.theme.variables %}
  <style>:root { {% for k, v in config.theme.variables.items() %}{{ k }}: {{ v }}; {% endfor %} }</style>
  {% endif %}

  <!-- Style config overrides (per HEAD_STYLE.md spec) -->
  {% if config.style %}
  <style>
    :root {
      {% if config.style.color_bg %}--color-background: {{ config.style.color_bg }};{% endif %}
      {% if config.style.color_text %}--color-text: {{ config.style.color_text }};{% endif %}
      {% if config.style.color_link %}--color-primary: {{ config.style.color_link }};{% endif %}
      {% if config.style.color_accent %}--color-primary-dark: {{ config.style.color_accent }};{% endif %}
      {% if config.style.body_width %}--content-width: {{ config.style.body_width }};{% endif %}
    }
    @media (prefers-color-scheme: light) {
      :root {
        {% if config.style.color_bg_light %}--color-background: {{ config.style.color_bg_light }};{% endif %}
        {% if config.style.color_text_light %}--color-text: {{ config.style.color_text_light }};{% endif %}
        {% if config.style.color_link_light %}--color-primary: {{ config.style.color_link_light }};{% endif %}
        {% if config.style.color_accent_light %}--color-primary-dark: {{ config.style.color_accent_light }};{% endif %}
      }
    }
  </style>
  {% endif %}

  <!-- Custom CSS file -->
  {% if config.theme.custom_css %}
  <link rel="stylesheet" href="{{ config.theme.custom_css | asset_url }}">
  {% endif %}

  <!-- RSS/Atom/JSON Feeds -->
  {% if config.head.alternate_feeds %}
  {% for feed in config.head.alternate_feeds %}
  <link rel="alternate" type="{{ feed.mime_type }}" title="{{ feed.title }}" href="{{ feed.href }}">
  {% endfor %}
  {% else %}
  {# Default feeds when no alternate_feeds configured #}
  <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml">
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
  {% endif %}

  <!-- Global head config (per HEAD_STYLE.md spec) -->
  {% if config.head %}
    <!-- Raw text/HTML -->
    {% if config.head.text %}{{ config.head.text | safe }}{% endif %}

    <!-- Meta tags -->
    {% for meta in config.head.meta %}
      {% if meta.name %}
      <meta name="{{ meta.name }}" content="{{ meta.content }}">
      {% elif meta.property %}
      <meta property="{{ meta.property }}" content="{{ meta.content }}">
      {% endif %}
    {% endfor %}

    <!-- Link tags -->
    {% for link in config.head.link %}
    <link rel="{{ link.rel }}" href="{{ link.href }}"{% if link.crossorigin %} crossorigin{% endif %}>
    {% endfor %}

    <!-- Script tags -->
    {% for script in config.head.script %}
    <script src="{{ script.src }}"></script>
    {% endfor %}
  {% endif %}

  {% include "partials/background-css.html" %}
  {% include "partials/aesthetic-css.html" %}
  {% endblock %}
</head>
<body>
  {% include "partials/background-decorations.html" %}
  {% block header %}
  <header class="site-header">
    <div class="container">
      <a href="/" class="site-title">{{ config.title | default:'My Site' }}</a>
      {% include "components/nav.html" %}

      {# Search and theme controls - pushed to right #}
      <div class="header-controls">
        {% if config.search.enabled and config.search.position == 'navbar' %}
        {% include "components/search.html" %}
        {% endif %}
        {% include "partials/palette-switcher.html" %}
      </div>
    </div>
  </header>
  {% endblock %}

  <div class="page-wrapper">
    {# Left sidebar for feed navigation (if enabled) #}
    {% if config.components.feed_sidebar.enabled and config.components.feed_sidebar.position == 'left' %}
    {% include "components/feed_sidebar.html" %}
    {% endif %}

    <main class="main-content">
      {% block content %}{% endblock %}
    </main>

    {# Right sidebar for document TOC (if enabled) #}
    {% if config.components.doc_sidebar.enabled and config.components.doc_sidebar.position == 'right' %}
    {% include "components/doc_sidebar.html" %}
    {% endif %}
  </div>

  {% block footer %}
  {% include "components/footer.html" %}
  {% endblock %}

  {% block htmx %}{% endblock %}
  {% block scripts %}{% endblock %}

  {# Shortcuts Modal - must be before conditional script loading so #shortcuts-modal exists when checked #}
  {% include "partials/shortcuts-modal.html" %}

  <!-- Conditional Script Loading: Only load when needed -->
  <script>
    // Custom Navigation Shortcuts from config
    {% if config.shortcuts and config.shortcuts.navigation %}
    window.customShortcuts = {
      navigation: {
        {% for key, url in config.shortcuts.navigation.items() %}"{{ key }}": "{{ url }}"{% if not loop.last %}, {% endif %}{% endfor %}
      }
    };
    {% endif %}

    // Wikilink Hover Tooltips - only load if wikilinks with data-title exist
    if (document.querySelector('.wikilink[data-title]')) {
      const script = document.createElement('script');
      script.src = '{{ 'js/tooltips.js' | theme_asset_hashed }}';
      script.defer = true;
      document.body.appendChild(script);
    }

    // Mention Cards - only load if mention links exist
    if (document.querySelector('a.mention')) {
      const mentionScript = document.createElement('script');
      mentionScript.src = '{{ 'js/mention-cards.js' | theme_asset_hashed }}';
      mentionScript.defer = true;
      document.body.appendChild(mentionScript);
    }

    // Keyboard Shortcuts Registry - load the core registry first, then load dependent scripts
    const shortcutsRegistryScript = document.createElement('script');
    shortcutsRegistryScript.src = '{{ 'js/shortcuts-registry.js' | theme_asset_hashed }}';
    // Use onload to ensure registry is fully loaded before dependent scripts
    shortcutsRegistryScript.onload = function() {
      // Keyboard Shortcuts - load search and core shortcuts
      if (document.querySelector('#pagefind-search, #shortcuts-modal, [type="search"]')) {
        const shortcutsScript = document.createElement('script');
        shortcutsScript.src = '{{ 'js/search-shortcuts.js' | theme_asset_hashed }}';
        document.body.appendChild(shortcutsScript);
      }

      // Scrolling Shortcuts - always available
      const scrollingScript = document.createElement('script');
      scrollingScript.src = '{{ 'js/scrolling-shortcuts.js' | theme_asset_hashed }}';
      document.body.appendChild(scrollingScript);

      // Navigation Shortcuts - load if post cards exist
      if (document.querySelector('.card, [data-card]')) {
        const navigationScript = document.createElement('script');
        navigationScript.src = '{{ 'js/navigation-shortcuts.js' | theme_asset_hashed }}';
        document.body.appendChild(navigationScript);
      }

      // History Shortcuts - always available (go back/forward)
      const historyScript = document.createElement('script');
      historyScript.src = '{{ 'js/history-shortcuts.js' | theme_asset_hashed }}';
      document.body.appendChild(historyScript);
    };
    document.body.appendChild(shortcutsRegistryScript);

    // Custom Shortcuts - load if custom shortcuts are defined in config
      {% if config.shortcuts and config.shortcuts.navigation %}
      const customShortcutsScript = document.createElement('script');
      customShortcutsScript.src = '{{ 'js/custom-shortcuts.js' | theme_asset_hashed }}';
      document.body.appendChild(customShortcutsScript);
      {% endif %}
    // Pagination (JS mode) - only load if JS pagination element exists
    if (document.querySelector('.pagination-js')) {
      const paginationScript = document.createElement('script');
      paginationScript.src = '{{ 'js/pagination.js' | theme_asset_hashed }}';
      paginationScript.defer = true;
      document.body.appendChild(paginationScript);
    }

    // GLightbox - only load if glightbox elements exist
    {% if config.Extra.glightbox_enabled %}
    if (document.querySelector('.glightbox')) {
      const glightboxScript = document.createElement('script');
      glightboxScript.src = '{% if config.Extra.asset_urls.glightbox-js %}{{ config.Extra.asset_urls.glightbox-js }}{% elif config.Extra.glightbox_cdn %}https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/js/glightbox.min.js{% else %}/js/glightbox.min.js{% endif %}';
      glightboxScript.onload = function() {
        const lightbox = GLightbox({
          selector: '{{ config.Extra.glightbox_options.selector | default:".glightbox" }}',
          openEffect: '{{ config.Extra.glightbox_options.openEffect | default:"zoom" }}',
          closeEffect: '{{ config.Extra.glightbox_options.closeEffect | default:"zoom" }}',
          slideEffect: '{{ config.Extra.glightbox_options.slideEffect | default:"slide" }}',
          touchNavigation: {{ config.Extra.glightbox_options.touchNavigation | default:true | yesno:"true,false" }},
          loop: {{ config.Extra.glightbox_options.loop | default:false | yesno:"true,false" }},
          draggable: {{ config.Extra.glightbox_options.draggable | default:true | yesno:"true,false" }}
        });
      };
      document.body.appendChild(glightboxScript);
    }
    {% endif %}
  </script>

  <!-- Pagefind Search JS (when enabled) -->
  {% if config.search.enabled %}
  <script>
    function initPagefindSearch() {
      if (typeof PagefindUI !== 'undefined' && document.getElementById('pagefind-search')) {
        new PagefindUI({
          element: '#pagefind-search',
          showSubResults: true,
          showImages: {{ config.search.show_images | yesno:"true,false" }},
          excerptLength: {{ config.search.excerpt_length | default:200 }},
          translations: {
            placeholder: '{{ config.search.placeholder | default:"Search..." }}'
          }
        });
      }
    }
  </script>
  <script src="/{{ config.search.pagefind.bundle_dir | default:'_pagefind' }}/pagefind-ui.js" onload="initPagefindSearch()"></script>
  {% endif %}

   <!-- Palette Switcher JS (when enabled) -->
   {# Note: Must load AFTER shortcuts-registry for keyboard shortcut registration #}
   {% if config.theme.switcher.enabled %}
   <script src="{{ 'js/palette-switcher.js' | theme_asset_hashed }}" defer></script>
   {% endif %}

  <!-- View Transitions API - Global Navigation Interceptor -->
  {% if config.view_transitions.enabled | default:true %}
  <script>
    // View Transitions Configuration
    window.VIEW_TRANSITIONS_CONFIG = {
      enabled: {{ config.view_transitions.enabled | default:true | yesno:"true,false" }},
      debug: {{ config.view_transitions.debug | default:false | yesno:"true,false" }},
      skipClasses: {{ config.view_transitions.skip_classes | default:"[]" | safe }},
      skipSelectors: {{ config.view_transitions.skip_selectors | default:"[]" | safe }},
      transitionDuration: {{ config.view_transitions.duration | default:300 }},
      updateMeta: {{ config.view_transitions.update_meta | default:true | yesno:"true,false" }},
      scrollToTop: {{ config.view_transitions.scroll_to_top | default:true | yesno:"true,false" }},
    };
  </script>
  <script src="{{ 'js/view-transitions.js' | theme_asset_hashed }}" defer></script>
  {% endif %}

  <!-- Decryption JS (always loaded for encrypted posts) -->
  <script src="{{ 'js/decryption.js' | theme_asset_hashed }}" defer></script>

   {% include "partials/background-scripts.html" %}
</body>
</html>
