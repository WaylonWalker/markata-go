{# Palette and Aesthetic Switcher UI Component #}
{# Rendered when config.theme.switcher.enabled is true #}
{# Contains: palette family dropdown, dark/light toggle, aesthetic dropdown #}

{% if config.theme.switcher.enabled %}
<div class="theme-switcher" data-pagefind-ignore>
  {# Dark/Light Mode Toggle #}
  <button class="palette-mode-toggle" type="button" aria-label="Toggle dark/light mode" title="Toggle dark/light mode">
    <span class="mode-icon" aria-hidden="true"></span>
  </button>

  {# Palette Family Selector #}
  <div class="palette-family-wrapper">
    <button class="palette-family-btn" type="button" aria-haspopup="listbox" aria-expanded="false">
      <span>Theme</span>
      <span class="palette-arrow" aria-hidden="true">&#9660;</span>
    </button>
    <div class="palette-family-dropdown" role="listbox" hidden>
      <div class="palette-search">
        <input type="text" placeholder="Search palettesâ€¦" aria-label="Search palettes" autocomplete="off">
      </div>
      <div class="palette-family-list">
        {# Family options are populated by palette-switcher.js from --palette-manifest #}
      </div>
    </div>
  </div>

  {# Aesthetic Selector #}
  <div class="aesthetic-wrapper">
    <select id="aesthetic-select" class="aesthetic-select" aria-label="Select aesthetic">
      {# Options are populated dynamically by palette-switcher.js from --aesthetic-manifest #}
    </select>
  </div>
</div>

<style>
/* Aesthetic selector styling - matches palette-switcher design */
.aesthetic-wrapper {
  position: relative;
}

.aesthetic-select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 2rem 0.5rem 0.75rem;
  background: var(--color-surface, #f5f5f5);
  color: var(--color-text, #333);
  border: 1px solid var(--color-border, #ddd);
  border-radius: var(--radius-md, 0.375rem);
  font-size: var(--text-sm, 0.875rem);
  cursor: pointer;
  transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
  white-space: nowrap;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.25rem 1.25rem;
}

.aesthetic-select:hover {
  background-color: var(--color-background, #fff);
  border-color: var(--color-primary, #6366f1);
}

.aesthetic-select:focus-visible {
  outline: 2px solid var(--color-primary, #6366f1);
  outline-offset: 2px;
}

.aesthetic-select option {
  background: var(--color-background, #fff);
  color: var(--color-text, #333);
  padding: 0.5rem;
}

/* Mobile responsiveness */
@media (max-width: 640px) {
  .aesthetic-select {
    padding: 0.375rem 1.75rem 0.375rem 0.5rem;
    font-size: var(--text-xs, 0.75rem);
  }
}

@media (max-width: 480px) {
  .aesthetic-select {
    max-width: 90px;
  }
}
</style>

<script>
(function() {
  'use strict';

  const AESTHETIC_KEY = 'selected-aesthetic';

  // Extract the manifest dynamically from CSS properties.
  function getAestheticManifest() {
    const styles = getComputedStyle(document.documentElement);
    let manifest = styles.getPropertyValue('--aesthetic-manifest').trim();

    if (!manifest || manifest === 'none' || manifest === '') {
      return [];
    }

    try {
      if (manifest.startsWith("'") && manifest.endsWith("'")) {
        manifest = manifest.slice(1, -1);
      }
      if (manifest.startsWith('"') && manifest.endsWith('"')) {
        manifest = manifest.slice(1, -1);
      }
      manifest = manifest.replace(/\\'/g, "'");

      return JSON.parse(manifest);
    } catch (e) {
      console.warn('[palette-switcher] Failed to parse aesthetic manifest:', e);
      return [];
    }
  }

  function getDefaultAesthetic() {
    const styles = getComputedStyle(document.documentElement);
    let def = styles.getPropertyValue('--aesthetic-default').trim();
    if (def.startsWith("'") || def.startsWith('"')) {
      def = def.slice(1, -1);
    }
    return def || 'balanced';
  }

  function applyAesthetic(name) {
    const root = document.documentElement;

    // Set data attribute for CSS targeting (auto-handled by generated aesthetic.css)
    root.dataset.aesthetic = name;

    // Persist selection
    localStorage.setItem(AESTHETIC_KEY, name);

    // Dispatch event for other components
    window.dispatchEvent(new CustomEvent('aesthetic-change', {
      detail: { aesthetic: name }
    }));
  }

  function initAesthetic() {
    const select = document.getElementById('aesthetic-select');
    if (!select) return;

    const manifest = getAestheticManifest();
    const defaultAesthetic = getDefaultAesthetic();

    // Populate the dropdown
    if (manifest && manifest.length > 0) {
      select.innerHTML = ''; // clear initial content
      manifest.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        // Capitalize display name
        option.textContent = item.displayName ? item.displayName.charAt(0).toUpperCase() + item.displayName.slice(1) : item.name;
        select.appendChild(option);
      });
    }

    // Load saved aesthetic
    let saved = localStorage.getItem(AESTHETIC_KEY);
    // fallback to default if saved not in manifest
    if (!saved || (manifest.length > 0 && !manifest.find(m => m.name === saved))) {
      saved = defaultAesthetic;
    }

    select.value = saved;
    applyAesthetic(saved);

    // Handle changes - use global API if available (for consistency with keyboard shortcuts)
    select.addEventListener('change', (e) => {
      if (window.markata && window.markata.paletteSwitcher && window.markata.paletteSwitcher.setAesthetic) {
        window.markata.paletteSwitcher.setAesthetic(e.target.value);
      } else {
        applyAesthetic(e.target.value);
      }
    });

    // Listen for aesthetic changes from keyboard shortcuts
    window.addEventListener('aesthetic-change', (e) => {
      if (e.detail && e.detail.aesthetic && select.value !== e.detail.aesthetic) {
        select.value = e.detail.aesthetic;
      }
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAesthetic);
  } else {
    // try immediately, but if styles haven't loaded, try again soon.
    initAesthetic();
    setTimeout(initAesthetic, 100);
  }

  // Expose API
  window.markata = window.markata || {};
  window.markata.aesthetic = {
    apply: applyAesthetic,
    get: () => localStorage.getItem(AESTHETIC_KEY) || getDefaultAesthetic(),
    list: () => getAestheticManifest().map(m => m.name)
  };
})();
</script>
{% endif %}
