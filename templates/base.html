<!DOCTYPE html>
<html lang="{{ config.lang | default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% if post %}{{ post.title }} - {% endif %}{{ config.title | default:"My Site" }}{% endblock %}</title>
    {% if post.description %}<meta name="description" content="{{ post.description }}">{% elif config.description %}<meta name="description" content="{{ config.description }}">{% endif %}
    
    <!-- Structured Data: OpenGraph -->
    {% if post.structured_data.opengraph %}
    {% for meta in post.structured_data.opengraph %}
    <meta property="{{ meta.property }}" content="{{ meta.content }}">
    {% endfor %}
    {% elif post %}
    {# Fallback to basic OG tags if no structured data #}
    <meta property="og:title" content="{{ post.title }}">
    <meta property="og:description" content="{{ post.description | default:config.description }}">
    <meta property="og:url" content="{{ config.url }}{{ post.slug }}/">
    <meta property="og:type" content="article">
    {% if post.cover_image %}<meta property="og:image" content="{{ config.url }}{{ post.cover_image }}">{% elif config.seo.default_image %}<meta property="og:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    <meta property="og:site_name" content="{{ config.title }}">
    {% else %}
    <meta property="og:title" content="{{ config.title }}">
    <meta property="og:description" content="{{ config.description }}">
    <meta property="og:url" content="{{ config.url }}">
    <meta property="og:type" content="website">
    {% if config.seo.default_image %}<meta property="og:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    <meta property="og:site_name" content="{{ config.title }}">
    {% endif %}
    
    <!-- Structured Data: Twitter Card -->
    {% if post.structured_data.twitter %}
    {% for meta in post.structured_data.twitter %}
    <meta name="{{ meta.name }}" content="{{ meta.content }}">
    {% endfor %}
    {% else %}
    {# Fallback to basic Twitter tags if no structured data #}
    <meta name="twitter:card" content="summary_large_image">
    {% if config.seo.twitter_handle %}<meta name="twitter:site" content="@{{ config.seo.twitter_handle }}">{% endif %}
    {% if post %}
    <meta name="twitter:title" content="{{ post.title }}">
    <meta name="twitter:description" content="{{ post.description | default:config.description }}">
    {% if post.cover_image %}<meta name="twitter:image" content="{{ config.url }}{{ post.cover_image }}">{% elif config.seo.default_image %}<meta name="twitter:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    {% else %}
    <meta name="twitter:title" content="{{ config.title }}">
    <meta name="twitter:description" content="{{ config.description }}">
    {% if config.seo.default_image %}<meta name="twitter:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    {% endif %}
    {% endif %}
    
    <!-- Canonical URL -->
    {% if post %}
    <link rel="canonical" href="{{ config.url }}{{ post.href }}">
    {% else %}
    <link rel="canonical" href="{{ config.url }}/">
    {% endif %}
    
    <!-- Alternate Post Formats -->
    {% if post %}
    {% if config.post_formats.markdown %}
    <link rel="alternate" type="text/markdown" title="Markdown Source" href="{{ post.href }}index.md">
    {% endif %}
    {% if config.post_formats.og %}
    <link rel="alternate" type="text/html" title="Social Card" href="{{ post.href }}og/">
    {% endif %}
    {% endif %}
    
    {% block head %}
    <!-- Theme CSS -->
    <link rel="stylesheet" href="{{ 'css/variables.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/main.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/components.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/admonitions.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/code.css' | theme_asset }}">
    <link rel="stylesheet" href="/css/chroma.css">
    
    <!-- RSS/Atom/JSON Feeds -->
    {% if config.head.alternate_feeds %}
    {% for feed in config.head.alternate_feeds %}
    <link rel="alternate" type="{{ feed.mime_type }}" title="{{ feed.title }}" href="{{ feed.href }}">
    {% endfor %}
    {% else %}
    {# Default feeds when no alternate_feeds configured #}
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
    {% endif %}
    
    <!-- IndieAuth -->
    {% if config.indieauth.enabled %}
    {% if config.indieauth.authorization_endpoint %}<link rel="authorization_endpoint" href="{{ config.indieauth.authorization_endpoint }}">{% endif %}
    {% if config.indieauth.token_endpoint %}<link rel="token_endpoint" href="{{ config.indieauth.token_endpoint }}">{% endif %}
    {% if config.indieauth.me_url %}<link rel="me" href="{{ config.indieauth.me_url }}">{% endif %}
    {% endif %}
    
    <!-- Webmention -->
    {% if config.webmention.enabled %}
    {% if config.webmention.endpoint %}<link rel="webmention" href="{{ config.webmention.endpoint }}">{% endif %}
    {% endif %}
    
    <!-- Pagefind Search CSS -->
    {% if config.search.enabled %}
    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    {% endif %}
    {% endblock %}
    
    <!-- Structured Data: JSON-LD -->
    {% if post.structured_data.jsonld %}
    <script type="application/ld+json">
    {{ post.structured_data.jsonld | safe }}
    </script>
    {% elif post %}
    {# Fallback to static JSON-LD if no structured data #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "{{ post.title }}",
      "description": "{{ post.description | default:config.description }}",
      "datePublished": "{{ post.date }}",
      "author": {
        "@type": "Person",
        "name": "{{ config.author }}"
      },
      "publisher": {
        "@type": "Organization",
        "name": "{{ config.title }}"{% if config.seo.logo_url %},
        "logo": {
          "@type": "ImageObject",
          "url": "{{ config.url }}{{ config.seo.logo_url }}"
        }{% endif %}
      }{% if post.cover_image %},
      "image": "{{ config.url }}{{ post.cover_image }}"{% elif config.seo.default_image %},
      "image": "{{ config.url }}{{ config.seo.default_image }}"{% endif %}
    }
    </script>
    {% else %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "{{ config.title }}",
      "description": "{{ config.description }}",
      "url": "{{ config.url }}"{% if config.seo.logo_url %},
      "publisher": {
        "@type": "Organization",
        "name": "{{ config.title }}",
        "logo": {
          "@type": "ImageObject",
          "url": "{{ config.url }}{{ config.seo.logo_url }}"
        }
      }{% endif %}
    }
    </script>
    {% endif %}
</head>
<body>
    {% block header %}
    <header class="site-header">
        <div class="container">
            <a href="/" class="site-title">{{ config.title | default:"Home" }}</a>
            {% include "components/nav.html" %}
            {% if config.search.enabled and config.search.position == "navbar" %}
            {% include "components/search.html" %}
            {% endif %}
        </div>
    </header>
    {% endblock %}
    
    <main>
        {% block content %}{% endblock %}
    </main>
    
    {% block footer %}
    {% include "components/footer.html" %}
    {% endblock %}
    
    {% block htmx %}{% endblock %}
    {% block scripts %}{% endblock %}
    <script src="{{ 'js/tooltips.js' | theme_asset }}" defer></script>
    
    <!-- Pagefind Search JS -->
    {% if config.search.enabled %}
    <script src="/_pagefind/pagefind-ui.js" defer></script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof PagefindUI !== 'undefined') {
                new PagefindUI({
                    element: "#pagefind-search",
                    showImages: {{ config.search.show_images | default:true | yesno:"true,false" }},
                    excerptLength: {{ config.search.excerpt_length | default:120 }},
                    showSubResults: true,
                    translations: {
                        placeholder: "{{ config.search.placeholder | default:'Search...' }}"
                    }
                });
            }
        });
    </script>
    {% endif %}
</body>
</html>
