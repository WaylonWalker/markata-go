<!DOCTYPE html>
<html lang="{{ config.lang | default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% if post.private %}<meta name="robots" content="noindex, nofollow">{% endif %}
    <title>{% block title %}{% if post %}{{ post.title }} - {% endif %}{{ config.title | default:"My Site" }}{% endblock %}</title>
    {% if post.description %}<meta name="description" content="{{ post.description }}">{% elif config.description %}<meta name="description" content="{{ config.description }}">{% endif %}

    <!-- Structured Data: OpenGraph -->
    {% if post.structured_data.opengraph %}
    {% for meta in post.structured_data.opengraph %}
    <meta property="{{ meta.property }}" content="{{ meta.content }}">
    {% endfor %}
    {% elif post %}
    {# Fallback to basic OG tags if no structured data #}
    <meta property="og:title" content="{{ post.title }}">
    <meta property="og:description" content="{{ post.description | default:config.description }}">
    <meta property="og:url" content="{{ config.url }}{{ post.slug }}/">
    <meta property="og:type" content="article">
    {% if post.cover_image %}<meta property="og:image" content="{{ config.url }}{{ post.cover_image }}">{% elif config.seo.default_image %}<meta property="og:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    <meta property="og:site_name" content="{{ config.title }}">
    {% else %}
    <meta property="og:title" content="{{ config.title }}">
    <meta property="og:description" content="{{ config.description }}">
    <meta property="og:url" content="{{ config.url }}">
    <meta property="og:type" content="website">
    {% if config.seo.default_image %}<meta property="og:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    <meta property="og:site_name" content="{{ config.title }}">
    {% endif %}

    <!-- Structured Data: Twitter Card -->
    {% if post.structured_data.twitter %}
    {% for meta in post.structured_data.twitter %}
    <meta name="{{ meta.name }}" content="{{ meta.content }}">
    {% endfor %}
    {% else %}
    {# Fallback to basic Twitter tags if no structured data #}
    <meta name="twitter:card" content="summary_large_image">
    {% if config.seo.twitter_handle %}<meta name="twitter:site" content="@{{ config.seo.twitter_handle }}">{% endif %}
    {% if post %}
    <meta name="twitter:title" content="{{ post.title }}">
    <meta name="twitter:description" content="{{ post.description | default:config.description }}">
    {% if post.cover_image %}<meta name="twitter:image" content="{{ config.url }}{{ post.cover_image }}">{% elif config.seo.default_image %}<meta name="twitter:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    {% else %}
    <meta name="twitter:title" content="{{ config.title }}">
    <meta name="twitter:description" content="{{ config.description }}">
    {% if config.seo.default_image %}<meta name="twitter:image" content="{{ config.url }}{{ config.seo.default_image }}">{% endif %}
    {% endif %}
    {% endif %}

    <!-- Pagefind default image fallback for search results -->
    {% if config.seo.default_image %}
    <meta data-pagefind-default-meta="image" content="{{ config.seo.default_image }}">
    {% endif %}

    <!-- Canonical URL -->
    {% if post %}
    <link rel="canonical" href="{{ config.url }}{{ post.href }}">
    {% else %}
    <link rel="canonical" href="{{ config.url }}/">
    {% endif %}

    <!-- Alternate Post Formats -->
    {% if post %}
    {% if config.post_formats.markdown %}
    <link rel="alternate" type="text/markdown" title="Markdown Source" href="{{ post.href }}index.md">
    {% endif %}
    {% if config.post_formats.og %}
    <link rel="alternate" type="text/html" title="Social Card" href="{{ post.href }}og/">
    {% endif %}
    {% endif %}

    {% block head %}
    <!-- Font Configuration -->
    {% if config.theme.font.google_fonts %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="{{ config.theme.font | google_fonts_url }}" rel="stylesheet">
    {% endif %}
    {% for url in config.theme.font.custom_urls %}
    <link href="{{ url }}" rel="stylesheet">
    {% endfor %}
    <style>
    :root {
        --font-family: {{ config.theme.font.family | default:"system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif" }};
        --font-heading: {{ config.theme.font.heading_family | default:config.theme.font.family | default:"system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif" }};
        --font-code: {{ config.theme.font.code_family | default:"ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, monospace" }};
        --font-size: {{ config.theme.font.size | default:"16px" }};
        --line-height: {{ config.theme.font.line_height | default:"1.6" }};
    }
    </style>

    <!-- Pagefind Search CSS - Load before theme CSS so theme can override defaults -->
    {% if config.search.enabled %}
    <link href="/_pagefind/pagefind-ui.css" rel="stylesheet">
    {% endif %}

    <!-- GLightbox CSS for image zoom -->
    {% if config.Extra.glightbox_enabled %}
    {% if config.Extra.glightbox_cdn %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
    {% else %}
    <link rel="stylesheet" href="/css/glightbox.min.css">
    {% endif %}
    <!-- GLightbox theme overrides to match site palette -->
    <style>
    .glightbox-clean .gslide-description {
        background: var(--color-background);
        color: var(--color-text);
    }
    .glightbox-clean .goverlay {
        background: color-mix(in srgb, var(--color-background) 90%, transparent);
    }
    .glightbox-clean .gclose,
    .glightbox-clean .gnext,
    .glightbox-clean .gprev {
        color: var(--color-text);
    }
    .glightbox-clean .gclose:hover,
    .glightbox-clean .gnext:hover,
    .glightbox-clean .gprev:hover {
        color: var(--color-accent);
    }
    </style>
    {% endif %}

    <!-- Theme CSS -->
    <link rel="stylesheet" href="{{ 'css/variables.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/main.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/components.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/layouts.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/admonitions.css' | theme_asset }}">
    <link rel="stylesheet" href="{{ 'css/code.css' | theme_asset }}">
    <link rel="stylesheet" href="/css/chroma.css">

    <!-- RSS/Atom/JSON Feeds -->
    {% if config.head.alternate_feeds %}
    {% for feed in config.head.alternate_feeds %}
    <link rel="alternate" type="{{ feed.mime_type }}" title="{{ feed.title }}" href="{{ feed.href }}">
    {% endfor %}
    {% else %}
    {# Default feeds when no alternate_feeds configured #}
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
    {% if config.feeds.json.enabled %}
    <link rel="alternate" type="application/json" title="JSON Feed" href="/feed.json">
    {% endif %}
    {% endif %}

    {% if config.webmention.enabled %}
    {% if config.webmention.endpoint %}<link rel="webmention" href="{{ config.webmention.endpoint }}">{% endif %}
    {% endif %}

    {% include "partials/background-css.html" %}
    {% endblock %}

    <!-- Structured Data: JSON-LD -->
    {% if post.structured_data.jsonld %}
    <script type="application/ld+json">
    {{ post.structured_data.jsonld | safe }}
    </script>
    {% elif post %}
    {# Fallback to static JSON-LD if no structured data #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "{{ post.title }}",
      "description": "{{ post.description | default:config.description }}",
      "datePublished": "{{ post.date }}",
      "author": {
        "@type": "Person",
        "name": "{{ config.author }}"
      },
      "publisher": {
        "@type": "Organization",
        "name": "{{ config.title }}"{% if config.seo.logo_url %},
        "logo": {
          "@type": "ImageObject",
          "url": "{{ config.url }}{{ config.seo.logo_url }}"
        }{% endif %}
      }{% if post.cover_image %},
      "image": "{{ config.url }}{{ post.cover_image }}"{% elif config.seo.default_image %},
      "image": "{{ config.url }}{{ config.seo.default_image }}"{% endif %}
    }
    </script>
    {% else %}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "{{ config.title }}",
      "description": "{{ config.description }}",
      "url": "{{ config.url }}"{% if config.seo.logo_url %},
      "publisher": {
        "@type": "Organization",
        "name": "{{ config.title }}",
        "logo": {
          "@type": "ImageObject",
          "url": "{{ config.url }}{{ config.seo.logo_url }}"
        }
      }{% endif %}
    }
    </script>
    {% endif %}
</head>
<body class="{% block body_class %}{% endblock %}">
    {% include "partials/background-decorations.html" %}

    {% block header %}
    <header class="site-header" data-pagefind-ignore>
        <div class="container">
            <a href="/" class="site-title">{{ config.title | default:"Home" }}</a>
            {% include "components/nav.html" %}
            {% if config.search.enabled and config.search.position == "navbar" %}
            {% include "components/search.html" %}
            {% endif %}
        </div>
    </header>
    {% endblock %}

    <main data-pagefind-body>
        {% block content %}{% endblock %}
    </main>

    {% block footer %}
    {% include "components/footer.html" %}
    {% endblock %}

    {# Keyboard Shortcuts Modal #}
    {% include "partials/shortcuts-modal.html" %}

    {% block htmx %}{% endblock %}
    {% block scripts %}{% endblock %}
    <script src="{{ 'js/tooltips.js' | theme_asset }}" defer></script>
    <script src="{{ 'js/shortcuts.js' | theme_asset }}" defer></script>
    <script src="{{ 'js/mention-cards.js' | theme_asset }}" defer></script>

    <!-- Pagefind Search JS -->
    {% if config.search.enabled %}
    <script src="/_pagefind/pagefind-ui.js" defer></script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof PagefindUI !== 'undefined') {
                new PagefindUI({
                    element: "#pagefind-search",
                    showImages: {{ config.search.show_images | default:false | yesno:"true,false" }},
                    excerptLength: {{ config.search.excerpt_length | default:15 }},
                    showSubResults: {{ config.search.show_sub_results | default:false | yesno:"true,false" }},
                    resetStyles: false,
                    translations: {
                        placeholder: "{{ config.search.placeholder | default:'Search' }}"
                    }
                });
            }
        });
    </script>
    {% endif %}

    {% include "partials/background-scripts.html" %}

    <!-- GLightbox JS for image zoom -->
    {% if config.Extra.glightbox_enabled %}
    {% if config.Extra.glightbox_cdn %}
    <script src="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/js/glightbox.min.js"></script>
    {% else %}
    <script src="/js/glightbox.min.js"></script>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const lightbox = GLightbox({
                selector: '{{ config.Extra.glightbox_options.selector | default:".glightbox" }}',
                openEffect: '{{ config.Extra.glightbox_options.openEffect | default:"zoom" }}',
                closeEffect: '{{ config.Extra.glightbox_options.closeEffect | default:"zoom" }}',
                slideEffect: '{{ config.Extra.glightbox_options.slideEffect | default:"slide" }}',
                touchNavigation: {{ config.Extra.glightbox_options.touchNavigation | default:true | yesno:"true,false" }},
                loop: {{ config.Extra.glightbox_options.loop | default:false | yesno:"true,false" }},
                draggable: {{ config.Extra.glightbox_options.draggable | default:true | yesno:"true,false" }}
            });
        });
    </script>
    {% endif %}
</body>
</html>
