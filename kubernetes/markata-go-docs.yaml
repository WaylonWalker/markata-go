# Kubernetes manifest for markata-go docs
# Split build and deploy with Longhorn storage

---
apiVersion: v1
kind: Namespace
metadata:
  name: markata-go-docs

---
# Longhorn PVC for persistent storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: markata-go-docs-site
  namespace: markata-go-docs
spec:
  storageClassName: longhorn-fast-replicated
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi

---
# CronJob for building docs only
apiVersion: batch/v1
kind: CronJob
metadata:
  name: markata-go-docs-build
  namespace: markata-go-docs
spec:
  schedule: "*/10 * * * *"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 60
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 600
      template:
        spec:
          securityContext:
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532
            fsGroup: 65532
            fsGroupChangePolicy: OnRootMismatch

          volumes:
            - name: site
              persistentVolumeClaim:
                claimName: markata-go-docs-site

          initContainers:
            - name: clone-repo
              image: alpine/git:v2.40.1
              securityContext:
                runAsNonRoot: true
                runAsUser: 65532
                runAsGroup: 65532
              command:
                - sh
                - -c
                - |
                  set -e
                  umask 002
                  mkdir -p /site/repo /site/cache /site/output
                  if [ -d /site/repo/.git ]; then
                    if [ ! -w /site/repo/.git ] || [ ! -w /site/repo/.git/objects ]; then
                      echo "repo not writable; remove /site/repo or fix PVC permissions" >&2
                      exit 1
                    fi
                    git -C /site/repo config core.sharedRepository group
                    git -C /site/repo fetch --depth=1 origin main
                    git -C /site/repo reset --hard FETCH_HEAD
                  else
                    git clone --depth=1 --single-branch --branch main https://github.com/WaylonWalker/markata-go.git /site/repo
                    git -C /site/repo config core.sharedRepository group
                  fi
              volumeMounts:
                - name: site
                  mountPath: /site

          containers:
            - name: build-docs
              image: ghcr.io/waylonwalker/markata-go:latest
              imagePullPolicy: Always
              command: ["markata-go", "build", "--output", "/site/output"]
              workingDir: /site/repo
              env:
                - name: TZ
                  value: America/Chicago
                - name: MARKATA_GO_URL
                  value: https://go.markata.dev
                - name: XDG_CACHE_HOME
                  value: /site/cache
              volumeMounts:
                - name: site
                  mountPath: /site

          restartPolicy: OnFailure

---
# Service for docs site
apiVersion: v1
kind: Service
metadata:
  name: markata-go-docs
  namespace: markata-go-docs
  labels:
    app: markata-go-docs
spec:
  selector:
    app: markata-go-docs
  ports:
    - name: http
      port: 80
      targetPort: 80

---
# Deployment for serving only (no build)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: markata-go-docs
  namespace: markata-go-docs
  labels:
    app: markata-go-docs
spec:
  replicas: 2
  selector:
    matchLabels:
      app: markata-go-docs
  template:
    metadata:
      labels:
        app: markata-go-docs
    spec:
      containers:
        - name: nginx
          image: nginx:stable-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
          volumeMounts:
            - name: webroot
              mountPath: /usr/share/nginx/html
              subPath: output
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
          env:
            - name: TZ
              value: America/Chicago
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 3
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: webroot
          persistentVolumeClaim:
            claimName: markata-go-docs-site
        - name: nginx-conf
          configMap:
            name: markata-go-docs-nginx

---
# nginx config
apiVersion: v1
kind: ConfigMap
metadata:
  name: markata-go-docs-nginx
  namespace: markata-go-docs
data:
  default.conf: |
    server {
      listen 80;
      server_name go.markata.dev;

      # Gzip compression
      gzip on;
      gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/x-javascript image/svg+xml;
      gzip_min_length 512;

      root /usr/share/nginx/html;
      index index.html;

      # HTML files with short cache
      location ~* \.(html)$ {
        add_header Cache-Control "public, max-age=0, s-maxage=60" always;
        try_files $uri =404;
      }

      # Static assets with long cache
      location ~* \.(?:css|js|mjs|json|ico|png|jpe?g|gif|webp|svg|avif|woff2?)$ {
        add_header Cache-Control "public, max-age=31536000, immutable" always;
        try_files $uri =404;
      }

      # Default location with SPA fallback
      location / {
        add_header Cache-Control "public, max-age=0, s-maxage=60" always;
        try_files $uri $uri/ /index.html;
      }
    }

---
# Ingress for external access
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: markata-go-docs
  namespace: markata-go-docs
  labels:
    app: markata-go-docs
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  rules:
    - host: go.markata.dev
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: markata-go-docs
                port:
                  number: 80
  tls:
    - hosts:
        - go.markata.dev
      secretName: markata-go-docs-tls
